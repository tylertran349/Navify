import numpy as np
import pandas as pd
from datetime import datetime
from pathlib import Path
from graph import Node, Edge

class flowDataRetriever:
    def __init__(self, database):
        # Define the base directory as the location of this script
        BASE_DIR = Path(__file__).resolve().parent.parent

        # Load eigenvector.txt from the relative path
        eigenvector_path = BASE_DIR / 'data' / 'eigenvector.txt'
        self.eigenvector = np.loadtxt(eigenvector_path, dtype=complex)

        # Load processedBikeData.csv from the relative path
        bike_data_path = BASE_DIR / 'data' / 'processedBikeData.csv'
        self.flows_df = pd.read_csv(bike_data_path)

        # Ensure the 'Time' column is in datetime format for accurate comparisons
        self.flows_df['Time'] = pd.to_datetime(self.flows_df['Time'], format='%H:%M:%S').dt.time

        flow_polygons = self.get_flow_poly_coords()
        self.flow_edges = database.get_edges_within_polygons(flow_polygons)

    def get_flow_edges(self):
        return self.flow_edges

    # Input can be made like: query_datetime = datetime.strptime("2023-11-06 08:00:00", "%Y-%m-%d %H:%M:%S")
    def get_traffic_data(self):
        # Get the current datetime
        query_datetime = pd.to_datetime(datetime.now())
        
        # Extract the day name and time from query_datetime
        day_name = query_datetime.strftime('%A')  # Get the weekday (e.g., 'Sunday')
        query_time = query_datetime.round('H').time()  # Round to nearest hour and keep time only
        
        # Check if the weekday column exists in the DataFrame
        if day_name not in self.flows_df.columns:
            raise ValueError(f"Column for '{day_name}' does not exist in the DataFrame.")

        # Find the row with the closest time
        time_diffs = self.flows_df['Time'].apply(lambda t: abs(pd.Timestamp.combine(query_datetime.date(), t) - pd.Timestamp.combine(query_datetime.date(), query_time)))
        closest_idx = time_diffs.idxmin()
        known_flow = self.flows_df.loc[closest_idx, day_name]

        # Set the known index as 8 (for 3rd street)
        known_index = 8

        # Calculate the scaling factor based on the known flow
        scaling_factor = known_flow / self.eigenvector[known_index]
        
        # Calculate the flow distribution using the scaling factor
        flow_distribution = np.real(self.eigenvector * scaling_factor)  # Ensure the result is real
        
        # Helper function to get average flows on the edge
        def av_flow(index1, index2):
            return (flow_distribution[index1] + flow_distribution[index2])/2
        
        edge_flows = [av_flow(1,5), av_flow(4,5), av_flow(5,6), av_flow(6,7), av_flow(7,8),
                      av_flow(8,9), av_flow(4, 22), av_flow(5,14), av_flow(6,10),av_flow(7,11),
                      av_flow(8,12), av_flow(10,15),av_flow(11,16), av_flow(12, 19), av_flow(14,15),av_flow(15,16), 
                      av_flow(14, 24), av_flow(15,17),av_flow(16,18), av_flow(17,18), 
                      av_flow(18,19), av_flow(22,23), av_flow(23, 24), av_flow(24, 25), av_flow(25, 26),
                      av_flow(26, 27), av_flow(27, 28), av_flow(23, 30), av_flow(25, 31), av_flow(26, 32),
                      av_flow(30, 31),av_flow(31,32), av_flow(30, 35), av_flow(32, 36), av_flow(35, 36)]

        return edge_flows
    

    def get_flow_poly_coords(self):
        polygons = [[[38.54275008738732, -121.75634540766967], [38.54289145618179, -121.75613727646922], [38.54381677233803, -121.75642756472247], [38.54361971526546, -121.75663569592291]],
                    [[38.54232169539178, -121.75868414515836],[38.54238595435193, -121.75610989083697],[38.54265584135756, -121.75634540772171],[38.54265584135756, -121.75860198810553]],
                    [[38.54240737399223, -121.75591271372458],[38.54233883111981, -121.75309198824479],[38.54264727353137, -121.75319057670818],[38.54282291375795, -121.75584698808233]],
                    [[38.54238595435127, -121.75282908535466],[38.54275865518786, -121.75096138168745],[38.54295571461975, -121.75099424450858],[38.54266440918174, -121.75282908535466]],
                    [[38.54278864252754, -121.75062179920249],[38.5430114052309, -121.74919774362047],[38.543281289889485, -121.74914297225193],[38.54298141798412, -121.75075872762388]],
                    [[38.53933182049891, -121.75901440451157],[38.53932325227706, -121.75857623356326],[38.54239061050865, -121.75849407650857],[38.5424720051038, -121.75891033890944]],
                    [[38.54101117231311, -121.75605675046205],[38.541071148437176, -121.75573359938768],[38.542561967448805, -121.75591434490384],[38.54243344978564, -121.75623749597824]],
                    [[38.541242508511225, -121.7527485595536],[38.5413538923436, -121.75245827130036],[38.54239061050867, -121.75273212814305],[38.54236490693319, -121.75319220763878]],
                    [[38.541640919121924, -121.75063438448986],[38.54171374662842, -121.75031671055231],[38.542789014759585, -121.75058509025814],[38.5426990527035, -121.75102326120647]],
                    [[38.541979352213005, -121.74878311212534],[38.54199648802291, -121.74843257536672],[38.54317884904504, -121.74873929503053],[38.54309745524984, -121.74917746597883]],
                    [[38.54118681652628, -121.75257876815601],[38.54146099201563, -121.75052484183578],[38.54183798160694, -121.750628907436],[38.54154238766284, -121.75260067670342]],
                    [[38.541465275999364, -121.75026741640364],[38.54173945042723, -121.74863522962114],[38.54198363614709, -121.7487612037688],[38.541675190889464, -121.7503440963196]],
                    [[38.54088642067185, -121.7526403024316],[38.54091159578625, -121.75242036131156],[38.54116754228226, -121.75254910733304],[38.541142367257486, -121.75269394660724]],
                    [[38.541159150608316, -121.75039797589052],[38.54121789230543, -121.7502424077812],[38.541499012620285, -121.75030678079196],[38.541494816802754, -121.75054817958227]],
                    [[38.54069345351309, -121.7483648868718],[38.540743803868125, -121.74813958133417],[38.54181793637894, -121.74845608197036],[38.541763390974005, -121.74868675192555]],
                    [[38.540173164430755, -121.75541373193302],[38.5406472989736, -121.75255449737224],[38.540861287876396, -121.75267251455863],[38.540412330033284, -121.75533863008714]],
                    [[38.54075219558255, -121.75228627624081],[38.54099135925973, -121.7504784675223],[38.541238913807284, -121.75056966262086],[38.5409074422706, -121.75236674250426]],
                    [[38.539203906214325, -121.75568195275322],[38.53917873050224, -121.75468953550417],[38.540282257610265, -121.75501676497548],[38.540181556218755, -121.75574632576397]],
                    [[38.53990462666988, -121.75238283569388],[38.54002211206527, -121.75206633505768],[38.54071443281934, -121.75230773384801],[38.54063471137503, -121.75267251424224]],
                    [[38.54036617533474, -121.75026925506447],[38.5404081341573, -121.74997421209854],[38.54103331771409, -121.75017269554833],[38.54099555510311, -121.75039800108594]],
                    [[38.539778766866476, -121.75207174542898],[38.54013541899072, -121.75019956369968],[38.5403074505596, -121.75026930112801],[38.54000115016327, -121.7521683049451]],
                    [[38.54017318205329, -121.74987769864596],[38.54045850232961, -121.7482844666299],[38.54067249179411, -121.74837566172847],[38.54037038883567, -121.74996889374452]],
                    [[38.53920811977126, -121.75220049149209],[38.53924588332065, -121.75192154177884],[38.53983750967293, -121.75207710988813],[38.539761983175524, -121.75240433935947]],
                    [[38.53915776834119, -121.75026393675205],[38.53918294406063, -121.7499688937861],[38.54015639845437, -121.74993670728074],[38.54013541897273, -121.75017810607105]],
                    [[38.53941993174028, -121.74829946040308],[38.53955420165268, -121.74795613767908],[38.54049827989755, -121.74795077326151],[38.54043953761275, -121.74830482482064]],
                    [[38.53896676892126, -121.75864742254137],[38.53902551240887, -121.75631926531928],[38.539273073722406, -121.75639436716517],[38.539302445347126, -121.75857768511307]],
                    [[38.53904649221423, -121.75606177327629],[38.539050688174584, -121.7551766443785],[38.53920593853513, -121.75527320389462],[38.53922691828791, -121.75592766283722]],
                    [[38.53905908082745, -121.7548011628167],[38.53923950686952, -121.75527859597975],[38.53922272307073, -121.75521958738658],[38.53924789876744, -121.75586868191161]],
                    [[38.539041609285064, -121.75427482272063],[38.538991257738466, -121.75225780171718],[38.53923462322055, -121.75230071705768],[38.53923462322055, -121.75419972087477]],
                    [[38.53900185539712, -121.75185278652341],[38.53897144785675, -121.75023669084835],[38.53916692467773, -121.75027556600205],[38.53918430036945, -121.75177503621602]],
                    [[38.538994333972376, -121.74989712031208],[38.53924714044525, -121.74817902363137],[38.53939350168132, -121.74832078078325],[38.539145130922776, -121.74993114202853]],
                    [[38.53755264171163, -121.75597557865406],[38.53756660912873, -121.75558868606088],[38.53900523856428, -121.75596367426658],[38.53897730428606, -121.75643389757215]],
                    [[38.537818022172786, -121.75443396040453],[38.53791113789204, -121.75409468536128],[38.53900989427625, -121.75432086872344],[38.53899592713939, -121.75470776131665]],
                    [[38.53786561917204, -121.75215703419487],[38.53791309181123, -121.75178529900803],[38.53893967996941, -121.7518915090614],[38.5389159439925, -121.75215703419487]],
                    [[38.53713152279833, -121.75555835484515],[38.53731682646524, -121.75391456218684],[38.53771768582573, -121.75444154277437],[38.537532383191454, -121.7557082300581]],
                    [[38.53766864265149, -121.75402046994562],[38.537823624494926, -121.75210845416294],[38.53809484191745, -121.7521678950681],[38.53800960226626, -121.75415916539099]],
                    [[38.537281186582085, -121.7559820198159],[38.53651401740776, -121.75526872895396],[38.537281186582085, -121.75553621302718],[38.537242440860354, -121.75604146072106]],
                    [[38.53689062180812, -121.75251015690657],[38.53699600369389, -121.7513390958271],[38.53796064608917, -121.75163963362624],[38.538082109386366, -121.75234739082055]],
                    [[38.53608477769753, -121.75526563421842],[38.536596704129664, -121.75225083154834],[38.53690721510858, -121.75266925611822],[38.53653795865856, -121.7553085495589]]
                    ]
        return polygons
